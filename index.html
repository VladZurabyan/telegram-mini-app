<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js">
    function showGame(id) {
      document.getElementById('main').style.display = 'none';
      document.getElementById(id).style.display = 'block';
    }
    function backToMain() {
      document.getElementById('main').style.display = 'block';
      ['game-coin','game-boxes','game-dice'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    function recordGame(game, bet, result, win) {
      const user = tg.initDataUnsafe?.user;
      if (!user) return;
      fetch(apiUrl + "/game", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user.id, game, bet, result, win })
      });
      const amount = win ? bet : -bet;
      fetch(apiUrl + "/balance/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: user.id, currency: "ton", amount })
      }).then(() => {
        fetch(`${apiUrl}/balance/${user.id}`)
          .then(res => res.json())
          .then(data => {
            document.querySelectorAll(".balance span")[0].textContent = data.ton.toFixed(2);
            document.querySelectorAll(".balance span")[1].textContent = data.usdt.toFixed(2);
          });
      });
    }

    function playCoin(choice) {
      const bet = parseFloat(document.getElementById("coinBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const result = Math.random() < 0.5 ? "heads" : "tails";
      const win = result === choice;
      document.getElementById("coinResult").innerText = `–í—ã–ø–∞–ª–æ: ${result === "heads" ? "–û–†–Å–õ" : "–†–ï–®–ö–ê"}\n` + (win ? "–ü–æ–±–µ–¥–∞!" : "–ü—Ä–æ–∏–≥—Ä—ã—à");
      recordGame("coin", bet, result, win);
    }

    function selectBox(choice) {
      const bet = parseFloat(document.getElementById("boxBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const prize = Math.floor(Math.random() * 3);
      const win = choice === prize;
      const result = win ? "win" : "lose";
      document.getElementById("boxResult").innerText = win ? "–ü—Ä–∏–∑ –Ω–∞–π–¥–µ–Ω! –ü–æ–±–µ–¥–∞!" : "–ü—É—Å—Ç–æ. –ü—Ä–æ–∏–≥—Ä—ã—à.";
      recordGame("boxes", bet, result, win);
    }

    function rollDice() {
      const bet = parseFloat(document.getElementById("diceBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const d1 = Math.floor(Math.random() * 6) + 1;
      const d2 = Math.floor(Math.random() * 6) + 1;
      const total = d1 + d2;
      const win = total >= 8;
      document.getElementById("dice1").src = `assets/dice${d1}.png`;
      document.getElementById("dice2").src = `assets/dice${d2}.png`;
      document.getElementById("diceResult").innerText = `–°—É–º–º–∞: ${total}\n` + (win ? "–ü–æ–±–µ–¥–∞!" : "–ü—Ä–æ–∏–≥—Ä—ã—à");
      recordGame("dice", bet, `${d1}+${d2}`, win);
    }

</script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0D2B4F;
      font-family: sans-serif;
      color: white;
      text-align: center;
    }
    .balance, .actions, footer, .game-button, .controller-icon {
      transition: all 0.3s ease;
    }
    .balance {
      display: flex;
      justify-content: space-around;
      margin: 20px auto;
      max-width: 370px;
    }
    .balance div {
      background: #123460;
      padding: 10px 15px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .balance img {
      width: 50px;
      height: 50px;
    }
    h2 {
      margin: 10px 0;
    }
    .controller-icon {
      width: 150px;
      margin: 10px auto;
    }
    .game-button {
      background: #123460;
      border: none;
      border-radius: 16px;
      padding: 12px;
      margin: 10px auto;
      width: 80%;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      color: white;
    }
    .game-button img {
      height: 60px;
    }
    .actions {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    .actions button {
      background: #123460;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      color: white;
      font-size: 16px;
    }
    footer {
      margin-top: 40px;
      font-size: 12px;
      opacity: 0.7;
    }
    footer img {
      height: 35px;
      vertical-align: middle;
      margin-right: 6px;
    }
    #rules, #partners {
      display: none;
      padding: 20px;
    }
    #rules button, #partners button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      background: #1D75FF;
      color: white;
    }
  </style>
</head>
<body>
  <div id="main">
    <div class="balance">
      <div><img src="assets/ton.png" /> <span>0.00</span></div>
      <div><img src="assets/usdt.png" /> <span>0.00</span></div>
    </div>

    <h2>–í–´–ë–ï–†–ò–¢–ï –ò–ì–†–£</h2>
    <img class="controller-icon" src="assets/controller.png" />

    <button class="game-button" onclick="showGame('game-coin')"><img src="assets/coin.png" /> –û–†–Å–õ –ò –†–ï–®–ö–ê</button>
    <button class="game-button" onclick="showGame('game-boxes')"><img src="assets/boxes.png" /> –¢–†–ò –ö–û–†–û–ë–ö–ò</button>
    <button class="game-button" onclick="showGame('game-dice')"><img src="assets/dice.png" /> –ö–£–ë–ò–ö–ò</button>

    <div class="actions">
      <button>–ü–û–ü–û–õ–ù–ò–¢–¨</button>
      <button>–í–´–í–ï–°–¢–ò</button>
    </div>

    <footer>
      <p><img src="assets/18plus.png" />
        <span style="text-decoration: underline; cursor: pointer;" onclick="showRules()">–ü–†–ê–í–ò–õ–ê</span>
        ‚ÄÉ‚ÄÉ
        <span style="text-decoration: underline; cursor: pointer;" onclick="showPartners()">–ü–ê–†–¢–ù–Å–†–ê–ú</span>
      </p>
      <p>–í–°–ï –ü–†–ê–í–ê –ó–ê–©–ò–©–ï–ù–´</p>
    </footer>
  </div>

  
  <div id="game-coin" style="display:none; padding: 20px;">
    <h2>–û—Ä—ë–ª –∏ —Ä–µ—à–∫–∞ ü™ô</h2>
    <input type="number" id="coinBet" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (TON)" min="1" />
    <br />
    <button class="game-button" onclick="playCoin('heads')">–û–†–Å–õ</button>
    <button class="game-button" onclick="playCoin('tails')">–†–ï–®–ö–ê</button>
    <div class="result-box" id="coinResult"></div>
    <button class="btn" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="game-boxes" style="display:none; padding: 20px;">
    <h2>–¢—Ä–∏ –∫–æ—Ä–æ–±–∫–∏ üéÅ</h2>
    <input type="number" id="boxBet" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (TON)" min="1" />
    <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
      <img src="assets/box1.png" class="box" onclick="selectBox(0)" style="width: 60px;" />
      <img src="assets/box2.png" class="box" onclick="selectBox(1)" style="width: 60px;" />
      <img src="assets/box3.png" class="box" onclick="selectBox(2)" style="width: 60px;" />
    </div>
    <div class="result-box" id="boxResult"></div>
    <button class="btn" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="game-dice" style="display:none; padding: 20px;">
    <h2>–ö—É–±–∏–∫–∏ üé≤</h2>
    <input type="number" id="diceBet" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (TON)" min="1" />
    <button class="game-button" onclick="rollDice()">–ë—Ä–æ—Å–∏—Ç—å</button>
    <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
      <img id="dice1" src="assets/dice1.png" class="dice" style="width: 60px;" />
      <img id="dice2" src="assets/dice2.png" class="dice" style="width: 60px;" />
    </div>
    <div class="result-box" id="diceResult"></div>
    <button class="btn" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="rules">
    <h3>–ü–†–ê–í–ò–õ–ê –ò–ì–†–´</h3>
    <p>
      –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –ª—é–±—ã–µ –ø—Ä–∞–≤–∏–ª–∞ ‚Äî —Ç–µ–∫—Å—Ç, —Å—Å—ã–ª–∫–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É, —É—Å–ª–æ–≤–∏—è –≤—ã–ø–ª–∞—Ç, —Ä–∞–±–æ—Ç—É —Å –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–æ–π –∏ –ø—Ä–æ—á–µ–µ.
    </p>
    <button onclick="goBack()">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="partners">
    <h3>–£–°–õ–û–í–ò–Ø –î–õ–Ø –ü–ê–†–¢–ù–Å–†–û–í</h3>
    <p>
      –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ, –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–º –ø—Ä–æ—Ü–µ–Ω—Ç–µ, —É—Å–ª–æ–≤–∏—è—Ö –≤—ã–ø–ª–∞—Ç—ã, —Å–ø–æ—Å–æ–±–∞—Ö –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è, –ø—Ä–∞–≤–∏–ª–∞—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ –∏ —Ç.–¥.
    </p>
    <button onclick="goBack()">–ù–∞–∑–∞–¥</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const user = tg.initDataUnsafe?.user;
    const apiUrl = "https://miniapp-backend.onrender.com";

    if (user) {
      // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      fetch(`${apiUrl}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: user.id, username: user.username || "unknown" })
      });

      // –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
      fetch(`${apiUrl}/balance/${user.id}`)
        .then(res => res.json())
        .then(data => {
          document.querySelectorAll(".balance span")[0].textContent = data.ton.toFixed(2);
          document.querySelectorAll(".balance span")[1].textContent = data.usdt.toFixed(2);
        })
        .catch(() => console.log("–ë–∞–ª–∞–Ω—Å –Ω–µ –Ω–∞–π–¥–µ–Ω"));
    }

    function showRules() {
      document.getElementById('main').style.display = 'none';
      document.getElementById('rules').style.display = 'block';
      document.getElementById('partners').style.display = 'none';
    }

    function showPartners() {
      document.getElementById('main').style.display = 'none';
      document.getElementById('rules').style.display = 'none';
      document.getElementById('partners').style.display = 'block';
    }

    function goBack() {
      document.getElementById('rules').style.display = 'none';
      document.getElementById('partners').style.display = 'none';
      document.getElementById('main').style.display = 'block';
    }
  
    function showGame(id) {
      document.getElementById('main').style.display = 'none';
      document.getElementById(id).style.display = 'block';
    }
    function backToMain() {
      document.getElementById('main').style.display = 'block';
      ['game-coin','game-boxes','game-dice'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    function recordGame(game, bet, result, win) {
      const user = tg.initDataUnsafe?.user;
      if (!user) return;
      fetch(apiUrl + "/game", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user.id, game, bet, result, win })
      });
      const amount = win ? bet : -bet;
      fetch(apiUrl + "/balance/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: user.id, currency: "ton", amount })
      }).then(() => {
        fetch(`${apiUrl}/balance/${user.id}`)
          .then(res => res.json())
          .then(data => {
            document.querySelectorAll(".balance span")[0].textContent = data.ton.toFixed(2);
            document.querySelectorAll(".balance span")[1].textContent = data.usdt.toFixed(2);
          });
      });
    }

    function playCoin(choice) {
      const bet = parseFloat(document.getElementById("coinBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const result = Math.random() < 0.5 ? "heads" : "tails";
      const win = result === choice;
      document.getElementById("coinResult").innerText = `–í—ã–ø–∞–ª–æ: ${result === "heads" ? "–û–†–Å–õ" : "–†–ï–®–ö–ê"}\n` + (win ? "–ü–æ–±–µ–¥–∞!" : "–ü—Ä–æ–∏–≥—Ä—ã—à");
      recordGame("coin", bet, result, win);
    }

    function selectBox(choice) {
      const bet = parseFloat(document.getElementById("boxBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const prize = Math.floor(Math.random() * 3);
      const win = choice === prize;
      const result = win ? "win" : "lose";
      document.getElementById("boxResult").innerText = win ? "–ü—Ä–∏–∑ –Ω–∞–π–¥–µ–Ω! –ü–æ–±–µ–¥–∞!" : "–ü—É—Å—Ç–æ. –ü—Ä–æ–∏–≥—Ä—ã—à.";
      recordGame("boxes", bet, result, win);
    }

    function rollDice() {
      const bet = parseFloat(document.getElementById("diceBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const d1 = Math.floor(Math.random() * 6) + 1;
      const d2 = Math.floor(Math.random() * 6) + 1;
      const total = d1 + d2;
      const win = total >= 8;
      document.getElementById("dice1").src = `assets/dice${d1}.png`;
      document.getElementById("dice2").src = `assets/dice${d2}.png`;
      document.getElementById("diceResult").innerText = `–°—É–º–º–∞: ${total}\n` + (win ? "–ü–æ–±–µ–¥–∞!" : "–ü—Ä–æ–∏–≥—Ä—ã—à");
      recordGame("dice", bet, `${d1}+${d2}`, win);
    }

</script>

</body>
</html>
