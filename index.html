<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>MiniApp –ò–≥—Ä—ã</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0D2B4F;
      font-family: sans-serif;
      color: white;
      text-align: center;
    }
    .hidden { display: none; }
    .balance {
      display: flex;
      justify-content: space-around;
      margin: 20px auto;
      max-width: 370px;
    }
    .balance div {
      background: #123460;
      padding: 10px 15px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .balance img {
      width: 50px;
      height: 50px;
    }
    .game-button {
      background: #123460;
      border: none;
      border-radius: 16px;
      padding: 12px;
      margin: 10px auto;
      width: 80%;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      color: white;
      justify-content: flex-start;
    }
    .game-button img {
      height: 60px;
    }
    .controller-icon {
      width: 150px;
      margin: 10px auto;
    }
    .btn {
      padding: 12px 20px;
      margin: 8px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      cursor: pointer;
      background: #1D75FF;
      color: white;
    }
    .btn-secondary {
      background-color: #123460;
    }
    input {
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
      margin-bottom: 12px;
      width: 60%;
    }
    .dice-row, .box-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }
    .dice, .box {
      width: 60px;
    }
    .result-box {
      font-size: 20px;
      margin-top: 20px;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div id="main">
    <div class="balance">
      <div><img src="assets/ton.png" /> <span id="tonBalance">0</span></div>
      <div><img src="assets/usdt.png" /> <span id="usdtBalance">0</span></div>
    </div>

    <h2>–í–´–ë–ï–†–ò–¢–ï –ò–ì–†–£</h2>
    <img class="controller-icon" src="assets/controller.png" />

    <button class="game-button" onclick="openGame('coin')"><img src="assets/coin.png" /> –û–†–Å–õ –ò –†–ï–®–ö–ê</button>
    <button class="game-button" onclick="openGame('boxes')"><img src="assets/boxes.png" /> –¢–†–ò –ö–û–†–û–ë–ö–ò</button>
    <button class="game-button" onclick="openGame('dice')"><img src="assets/dice.png" /> –ö–£–ë–ò–ö–ò</button>
  </div>

  <div id="coin" class="hidden">
    <h2>–û—Ä—ë–ª –∏ —Ä–µ—à–∫–∞ ü™ô</h2>
    <input type="number" id="coinBet" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (TON)" min="1" />
    <br />
    <button class="btn" onclick="playCoin('heads')">–û–†–Å–õ</button>
    <button class="btn" onclick="playCoin('tails')">–†–ï–®–ö–ê</button>
    <div class="result-box" id="coinResult"></div>
    <button class="btn btn-secondary" onclick="resetAndBack()">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="boxes" class="hidden">
    <h2>–¢—Ä–∏ –∫–æ—Ä–æ–±–∫–∏ üéÅ</h2>
    <input type="number" id="boxBet" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (TON)" min="1" />
    <div class="box-row">
      <img src="assets/box1.png" class="box" onclick="selectBox(0)" />
      <img src="assets/box2.png" class="box" onclick="selectBox(1)" />
      <img src="assets/box3.png" class="box" onclick="selectBox(2)" />
    </div>
    <div class="result-box" id="boxResult"></div>
    <button class="btn btn-secondary" onclick="resetAndBack()">–ù–∞–∑–∞–¥</button>
  </div>

  <div id="dice" class="hidden">
    <h2>–ö—É–±–∏–∫–∏ üé≤</h2>
    <p>–ï—Å–ª–∏ —Å—É–º–º–∞ ‚â• 8 ‚Äî –ø–æ–±–µ–¥–∞!</p>
    <input type="number" id="diceBet" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (TON)" min="1" />
    <button class="btn" onclick="rollDice()">–ë—Ä–æ—Å–∏—Ç—å</button>
    <div class="dice-row">
      <img id="dice1" src="assets/dice1.png" class="dice" />
      <img id="dice2" src="assets/dice2.png" class="dice" />
    </div>
    <div class="result-box" id="diceResult"></div>
    <button class="btn btn-secondary" onclick="resetAndBack()">–ù–∞–∑–∞–¥</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    const user = tg.initDataUnsafe?.user;
    const apiUrl = "https://miniapp-backend.onrender.com";

    if (user) {
      fetch(`${apiUrl}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: user.id, username: user.username || "unknown" })
      });

      fetch(`${apiUrl}/balance/${user.id}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("tonBalance").innerText = data.ton.toFixed(2);
          document.getElementById("usdtBalance").innerText = data.usdt.toFixed(2);
        });
    }

    function openGame(game) {
      document.getElementById("main").classList.add("hidden");
      document.getElementById(game).classList.remove("hidden");
    }

    function resetAndBack() {
      ["coin", "boxes", "dice"].forEach(id => document.getElementById(id).classList.add("hidden"));
      document.getElementById("main").classList.remove("hidden");
      document.getElementById("coinResult").innerText = "";
      document.getElementById("boxResult").innerText = "";
      document.getElementById("diceResult").innerText = "";
    }

    function playCoin(choice) {
      const bet = parseFloat(document.getElementById("coinBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const result = Math.random() < 0.5 ? "heads" : "tails";
      const win = result === choice;
      document.getElementById("coinResult").innerText = `–í—ã–ø–∞–ª–æ: ${result === "heads" ? "–û–†–Å–õ" : "–†–ï–®–ö–ê"}
${win ? "–ü–æ–±–µ–¥–∞!" : "–ü—Ä–æ–∏–≥—Ä—ã—à"}`;
      recordGame("coin", bet, result, win);
    }

    function selectBox(choice) {
      const bet = parseFloat(document.getElementById("boxBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const prizeIndex = Math.floor(Math.random() * 3);
      const win = choice === prizeIndex;
      const result = win ? "win" : "lose";
      document.getElementById("boxResult").innerText = win ? "–í—ã –Ω–∞—à–ª–∏ –ø—Ä–∏–∑! –ü–æ–±–µ–¥–∞!" : "–ü—É—Å—Ç–æ. –ü—Ä–æ–∏–≥—Ä—ã—à.";
      recordGame("boxes", bet, result, win);
    }

    function rollDice() {
      const bet = parseFloat(document.getElementById("diceBet").value);
      if (!bet || bet < 1) return alert("–ú–∏–Ω–∏–º—É–º 1 TON");
      const d1 = Math.floor(Math.random() * 6) + 1;
      const d2 = Math.floor(Math.random() * 6) + 1;
      document.getElementById("dice1").src = `assets/dice${d1}.png`;
      document.getElementById("dice2").src = `assets/dice${d2}.png`;
      const total = d1 + d2;
      const win = total >= 8;
      document.getElementById("diceResult").innerText = `–°—É–º–º–∞: ${total}
${win ? "–ü–æ–±–µ–¥–∞!" : "–ü—Ä–æ–∏–≥—Ä—ã—à"}`;
      recordGame("dice", bet, `${d1}+${d2}`, win);
    }

    function recordGame(game, bet, result, win) {
      if (!user) return;
      fetch(`${apiUrl}/game`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user.id, game, bet, result, win })
      });
      const amount = win ? bet : -bet;
      fetch(`${apiUrl}/balance/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: user.id, currency: "ton", amount: amount })
      }).then(() => {
        fetch(`${apiUrl}/balance/${user.id}`)
          .then(res => res.json())
          .then(data => {
            document.getElementById("tonBalance").innerText = data.ton.toFixed(2);
          });
      });
    }
  </script>
</body>
</html>
