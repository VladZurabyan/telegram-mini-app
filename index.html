<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0D2B4F;
      font-family: sans-serif;
      color: white;
      text-align: center;
    }
    .balance, .actions, footer, .game-button, .controller-icon {
      transition: all 0.3s ease;
    }
    .balance {
      display: flex;
      justify-content: space-around;
      margin: 20px auto;
      max-width: 370px;
    }
    .balance div {
      background: #123460;
      padding: 10px 15px;
      border-radius: 15px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .balance img {
      width: 50px;
      height: 50px;
    }
    h2 {
      margin: 10px 0;
    }
    .controller-icon {
      width: 150px;
      margin: 10px auto;
    }
    .game-button {
      background: #123460;
      border: none;
      border-radius: 16px;
      padding: 12px;
      margin: 10px auto;
      width: 80%;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      color: white;
    }
    .game-button img {
      height: 60px;
    }
    .actions {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
    }
    .actions button {
      background: #123460;
      border: none;
      padding: 10px 20px;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    footer {
      margin-top: 40px;
      font-size: 12px;
      opacity: 0.7;
    }
    footer img {
      height: 35px;
      vertical-align: middle;
      margin-right: 6px;
    }
    #rules, #partners {
      display: none;
      padding: 20px;
    }
    #rules button, #partners button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      background: #1D75FF;
      color: white;
    }

    /* Блок ввода ставки с кнопками */
    .bet-container {
      margin: 20px auto;
      max-width: 300px;
      font-size: 16px;
      text-align: center;
    }
    .bet-box {
      display: flex;
      justify-content: space-between;
      background: linear-gradient(90deg, #e6004c, #c20039);
      color: white;
      padding: 12px 10px;
      border-radius: 16px;
      margin: 10px 0;
      font-weight: bold;
    }
    .bet-box button {
      background: transparent;
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .bet-box span {
      width: 50px;
      text-align: center;
    }
    .win-multiplier {
      margin: 10px 0;
    }
    .actions button.active {
      background: #00ff99;
      color: black;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="main">
    <div class="balance">
      <div><img src="assets/ton.png" /> <span>0.00</span></div>
      <div><img src="assets/usdt.png" /> <span>0.00</span></div>
    </div>

    <h2>ВЫБЕРИТЕ ИГРУ</h2>
    <img class="controller-icon" src="assets/controller.png" />

    <button class="game-button" onclick="showGame('game-coin')"><img src="assets/coin.png" /> ОРЁЛ И РЕШКА</button>
    <button class="game-button" onclick="showGame('game-boxes')"><img src="assets/boxes.png" /> ТРИ КОРОБКИ</button>
    <button class="game-button" onclick="showGame('game-dice')"><img src="assets/dice.png" /> КУБИКИ</button>

    <div class="actions">
      <button>ПОПОЛНИТЬ</button>
      <button>ВЫВЕСТИ</button>
    </div>

    <footer>
      <p><img src="assets/18plus.png" />
        <span style="text-decoration: underline; cursor: pointer;" onclick="showRules()">ПРАВИЛА</span>
          
        <span style="text-decoration: underline; cursor: pointer;" onclick="showPartners()">ПАРТНЁРАМ</span>
      </p>
      <p>ВСЕ ПРАВА ЗАЩИЩЕНЫ</p>
    </footer>
  </div>

  <!-- Игра Орёл и решка -->
  <div id="game-coin" style="display:none; padding: 20px;">
    <div class="balance">
      <div><img src="assets/ton.png" /> <span>0.00</span></div>
      <div><img src="assets/usdt.png" /> <span>0.00</span></div>
    </div>
    <h2>COIN FLIP</h2>
    <img id="coinImageMain" src="assets/coin-heads.png" style="width: 100px; height: 100px; margin: 20px auto;" />
    
    <div class="actions" style="margin-top: 20px;">
      <button id="btn-heads" onclick="setCoinChoice('heads')">ОРЁЛ</button>
      <button id="btn-tails" onclick="setCoinChoice('tails')">РЕШКА</button>
    </div>
    <button class="game-button" onclick="playCoin()">PLAY</button>

    <div class="result-box" id="coinResult" style="margin-top: 20px;"></div>
    <div class="prize-box" id="coinPrize" style="margin-top: 10px; font-size: 18px; color: #00ff99;"></div>

    <div class="bet-container">
      <label>Введите ставку</label>
      <div class="bet-box">
        <button onclick="setBet('min')">min</button>
        <button onclick="changeBet(-10)">-</button>
        <span id="betValue">100</span>
        <button onclick="changeBet(10)">+</button>
        <button onclick="setBet('max')">max</button>
      </div>
      <div class="win-multiplier">Возможный выигрыш: <strong>2x</strong></div>
    </div>

    <button class="btn" onclick="backToMain()">Назад</button>
  </div>

  <!-- Другие игры тут... -->

  <div id="rules">
    <h3>ПРАВИЛА ИГРЫ</h3>
    <p>Здесь вы можете разместить любые правила…</p>
    <button onclick="goBack()">Назад</button>
  </div>

  <div id="partners">
    <h3>УСЛОВИЯ ДЛЯ ПАРТНЁРОВ</h3>
    <p>Информация о партнёрской программе…</p>
    <button onclick="goBack()">Назад</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const user = tg.initDataUnsafe?.user;
    const apiUrl = "https://miniapp-backend.onrender.com";

    if (user) {
      fetch(`${apiUrl}/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: user.id, username: user.username || "unknown" })
      });
      fetch(`${apiUrl}/balance/${user.id}`)
        .then(res => res.json())
        .then(data => {
          document.querySelectorAll(".balance span")[0].textContent = data.ton.toFixed(2);
          document.querySelectorAll(".balance span")[1].textContent = data.usdt.toFixed(2);
        });
    }

    function showRules() {
      document.getElementById('main').style.display = 'none';
      document.getElementById('rules').style.display = 'block';
      document.getElementById('partners').style.display = 'none';
    }
    function showPartners() {
      document.getElementById('main').style.display = 'none';
      document.getElementById('rules').style.display = 'none';
      document.getElementById('partners').style.display = 'block';
    }
    function goBack() {
      document.getElementById('rules').style.display = 'none';
      document.getElementById('partners').style.display = 'none';
      document.getElementById('main').style.display = 'block';
    }
    function showGame(id) {
      document.getElementById('main').style.display = 'none';
      document.getElementById(id).style.display = 'block';
      if (id === 'game-coin') updateBetUI();
    }
    function backToMain() {
      document.getElementById('main').style.display = 'block';
      ['game-coin','game-boxes','game-dice'].forEach(id => {
        document.getElementById(id).style.display = 'none';
      });
    }

    function recordGame(game, bet, result, win) {
      const user = tg.initDataUnsafe?.user;
      if (!user) return;
      fetch(apiUrl + "/game", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: user.id, game, bet, result, win })
      });
      const amount = win ? bet : -bet;
      fetch(apiUrl + "/balance/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: user.id, currency: "ton", amount })
      }).then(() => {
        fetch(`${apiUrl}/balance/${user.id}`)
          .then(res => res.json())
          .then(data => {
            document.querySelectorAll(".balance span")[0].textContent = data.ton.toFixed(2);
            document.querySelectorAll(".balance span")[1].textContent = data.usdt.toFixed(2);
          });
      });
    }

    // Ставка
    let bet = 100;
    const minBet = 10;
    const maxBet = 1000;
    function updateBetUI() {
      document.querySelectorAll("#betValue").forEach(span => span.innerText = bet);
    }
    function changeBet(delta) {
      bet = Math.min(Math.max(bet + delta, minBet), maxBet);
      updateBetUI();
    }
    function setBet(type) {
      if (type === "min") bet = minBet;
      else if (type === "max") bet = maxBet;
      updateBetUI();
    }

    // Выбор стороны
    let playerChoice = "";
    function setCoinChoice(choice) {
      playerChoice = choice;
      document.getElementById("btn-heads").classList.remove("active");
      document.getElementById("btn-tails").classList.remove("active");
      document.getElementById("btn-" + choice).classList.add("active");
    }

    // Логика игры
    function playCoin() {
      if (!bet || bet < 1) return alert("Минимум 1 TON");
      if (!playerChoice) return alert("Выберите сторону");
      const result = Math.random() < 0.5 ? "heads" : "tails";
      const img = document.getElementById("coinImageMain");
      img.src = "assets/coin-" + result + ".png";
      const win = result === playerChoice;
      document.getElementById("coinResult").innerText = 
        `Выпало: ${result === "heads" ? "ОРЁЛ" : "РЕШКА"}\n${win ? "Победа!" : "Проигрыш"}`;
      recordGame("coin", bet, result, win);
    }
  </script>
</body>
</html>
