<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      margin: 0; padding: 0;
      background: #0D2B4F;
      font-family: sans-serif;
      color: white; text-align: center;
    }
    .balance, .actions, footer, .game-button, .controller-icon {
      transition: all 0.3s ease;
    }
    .balance {
      display: flex; justify-content: space-around;
      margin: 20px auto; max-width: 370px;
    }
    .balance div {
      background: #123460; padding: 10px 15px;
      border-radius: 15px; display: flex;
      align-items: center; gap: 5px;
    }
    .balance img { width: 50px; height: 50px; }
    h2 { margin: 10px 0; }
    .controller-icon { width: 150px; margin: 10px auto; }
    .game-button {
      background: #123460; border: none;
      border-radius: 16px; padding: 12px;
      margin: 10px auto; width: 80%;
      display: flex; align-items: center;
      gap: 12px; font-size: 18px; color: white;
    }
    .game-button img { height: 60px; }
    .actions {
      display: flex; justify-content: space-around;
      margin-top: 20px;
    }
    .actions button {
      background: #123460; border: none;
      padding: 10px 20px; border-radius: 12px;
      color: white; font-size: 16px;
      cursor: pointer;
    }
    footer {
      margin-top: 40px; font-size: 12px; opacity: 0.7;
    }
    footer img {
      height: 35px; vertical-align: middle;
      margin-right: 6px;
    }
    #rules, #partners { display: none; padding: 20px; }
    #rules button, #partners button {
      margin-top: 20px; padding: 10px 20px;
      font-size: 16px; border-radius: 12px;
      border: none; background: #1D75FF;
      color: white;
    }

    /* –°—Ç–∞–≤–∫–∏ */
    .bet-container {
      margin: 20px auto; max-width: 300px;
      font-size: 16px; text-align: center;
    }
    .bet-box {
      display: flex; justify-content: space-between;
      background: linear-gradient(90deg, #e6004c, #c20039);
      color: white; padding: 12px 10px;
      border-radius: 16px; margin: 10px 0;
      font-weight: bold;
    }
    .bet-box button {
      background: transparent; border: none;
      color: white; font-size: 16px; cursor: pointer;
    }
    .bet-box span {
      width: 50px; text-align: center;
    }
    .win-multiplier { margin: 10px 0; }
    .actions button.active {
      background: #00ff99; color: black;
      font-weight: bold;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –º–æ–Ω–µ—Ç—ã */
    .coin-image {
      width: 100px; height: 100px;
      margin: 20px auto; transform-style: preserve-3d;
    }
    .coin-image.flip {
      animation: flipCoin 1.2s ease-in-out;
    }
    @keyframes flipCoin {
      0%   { transform: rotateY(0deg); }
      50%  { transform: rotateY(180deg); }
      100% { transform: rotateY(360deg); }
    }
  </style>
</head>
<body>

  <!-- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù -->
  <div id="main">
    <div class="balance">
      <div><img src="assets/ton.png" /><span>0.00</span></div>
      <div><img src="assets/usdt.png" /><span>0.00</span></div>
    </div>
    <h2>–í–´–ë–ï–†–ò–¢–ï –ò–ì–†–£</h2>
    <img class="controller-icon" src="assets/controller.png" />

    <button class="game-button" onclick="showGame('game-coin')">
      <img src="assets/coin.png" /> –û–†–Å–õ –ò –†–ï–®–ö–ê
    </button>
    <button class="game-button" onclick="showGame('game-boxes')">
      <img src="assets/boxes.png" /> –¢–†–ò –ö–û–†–û–ë–ö–ò
    </button>
    <button class="game-button" onclick="showGame('game-dice')">
      <img src="assets/dice.png" /> –ö–£–ë–ò–ö–ò
    </button>

    <div class="actions">
      <button>–ü–û–ü–û–õ–ù–ò–¢–¨</button>
      <button>–í–´–í–ï–°–¢–ò</button>
    </div>

    <footer>
      <p>
        <img src="assets/18plus.png" />
        <span onclick="showRules()" style="text-decoration:underline;cursor:pointer">–ü–†–ê–í–ò–õ–ê</span>
        ‚ÄÉ‚ÄÉ
        <span onclick="showPartners()" style="text-decoration:underline;cursor:pointer">–ü–ê–†–¢–ù–Å–†–ê–ú</span>
      </p>
      <p>–í–°–ï –ü–†–ê–í–ê –ó–ê–©–ò–©–ï–ù–´</p>
    </footer>
  </div>

  <!-- –ò–ì–†–ê: –û–†–Å–õ –ò –†–ï–®–ö–ê -->
  <div id="game-coin" style="display:none; padding:20px;">
    <div class="balance">
      <div><img src="assets/ton.png" /><span>0.00</span></div>
      <div><img src="assets/usdt.png" /><span>0.00</span></div>
    </div>
    <h2>COIN FLIP</h2>
    <img id="coinImageMain" class="coin-image" src="assets/coin-heads.png" />

    <div class="actions" style="margin-top:20px;">
      <button id="btn-heads" onclick="setCoinChoice('heads')">–û–†–Å–õ</button>
      <button id="btn-tails" onclick="setCoinChoice('tails')">–†–ï–®–ö–ê</button>
    </div>
    <button class="game-button" onclick="playCoin()">PLAY</button>
    <div class="result-box" id="coinResult" style="margin-top:20px;"></div>
    <div class="prize-box" id="coinPrize" style="margin-top:10px;font-size:18px;color:#00ff99;"></div>

    <div class="bet-container">
      <label>–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É</label>
      <div class="bet-box">
        <button onclick="setBet('min')">min</button>
        <button onclick="changeBet(-10)">-</button>
        <span id="betValue">100</span>
        <button onclick="changeBet(10)">+</button>
        <button onclick="setBet('max')">max</button>
      </div>
      <div class="win-multiplier">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: <strong>2x</strong></div>
    </div>
    <button class="btn" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ò–ì–†–ê: –¢–†–ò –ö–û–†–û–ë–ö–ò -->
  <div id="game-boxes" style="display:none; padding:20px;">
    <h2>–¢–†–ò –ö–û–†–û–ë–ö–ò üéÅ</h2>
    <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;">
      <img src="assets/box1.png" onclick="selectBox(0)" style="width:60px;cursor:pointer" />
      <img src="assets/box2.png" onclick="selectBox(1)" style="width:60px;cursor:pointer" />
      <img src="assets/box3.png" onclick="selectBox(2)" style="width:60px;cursor:pointer" />
    </div>
    <div class="result-box" id="boxResult"></div>
    <div class="bet-container">
      <label>–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É</label>
      <div class="bet-box">
        <button onclick="setBet('min')">min</button>
        <button onclick="changeBet(-10)">-</button>
        <span id="betValue">100</span>
        <button onclick="changeBet(10)">+</button>
        <button onclick="setBet('max')">max</button>
      </div>
      <div class="win-multiplier">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: <strong>2x</strong></div>
    </div>
    <button class="btn" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ò–ì–†–ê: –ö–£–ë–ò–ö–ò -->
  <div id="game-dice" style="display:none; padding:20px;">
    <h2>–ö–£–ë–ò–ö–ò üé≤</h2>
    <button class="game-button" onclick="rollDice()">–ë—Ä–æ—Å–∏—Ç—å</button>
    <div style="display:flex;justify-content:center;gap:20px;margin:20px 0;">
      <img id="dice1" src="assets/dice1.png" style="width:60px" />
      <img id="dice2" src="assets/dice2.png" style="width:60px" />
    </div>
    <div class="result-box" id="diceResult"></div>
    <div class="bet-container">
      <label>–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É</label>
      <div class="bet-box">
        <button onclick="setBet('min')">min</button>
        <button onclick="changeBet(-10)">-</button>
        <span id="betValue">100</span>
        <button onclick="changeBet(10)">+</button>
        <button onclick="setBet('max')">max</button>
      </div>
      <div class="win-multiplier">–í–æ–∑–º–æ–∂–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à: <strong>2x</strong></div>
    </div>
    <button class="btn" onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ü–†–ê–í–ò–õ–ê –ò –ü–ê–†–¢–ù–Å–†–´ -->
  <div id="rules" style="display:none; padding:20px;">
    <h3>–ü–†–ê–í–ò–õ–ê –ò–ì–†–´</h3>
    <p>...</p><button onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>
  <div id="partners" style="display:none; padding:20px;">
    <h3>–£–°–õ–û–í–ò–Ø –î–õ–Ø –ü–ê–†–¢–ù–Å–†–û–í</h3>
    <p>...</p><button onclick="backToMain()">–ù–∞–∑–∞–¥</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp; tg.ready();
    const user = tg.initDataUnsafe?.user;
    const apiUrl = "https://miniapp-backend.onrender.com";
    if (user) {
      fetch(`${apiUrl}/register`,{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:user.id,username:user.username||"unknown"})});
      fetch(`${apiUrl}/balance/${user.id}`)
        .then(r=>r.json()).then(d=>{
          document.querySelectorAll(".balance span")[0].textContent=d.ton.toFixed(2);
          document.querySelectorAll(".balance span")[1].textContent=d.usdt.toFixed(2);
        });
    }

    function showRules(){hideAll();document.getElementById('rules').style.display='block'}
    function showPartners(){hideAll();document.getElementById('partners').style.display='block'}
    function showGame(id){hideAll();document.getElementById(id).style.display='block';
      if(id==='game-coin') updateBetUI();}
    function backToMain(){hideAll();document.getElementById('main').style.display='block'}
    function hideAll(){
      ['main','game-coin','game-boxes','game-dice','rules','partners']
      .forEach(i=>document.getElementById(i).style.display='none');
    }

    function recordGame(game,bet,result,win){
      const u=tg.initDataUnsafe?.user; if(!u) return;
      fetch(apiUrl+"/game",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({user_id:u.id,game,bet,result,win})});
      fetch(apiUrl+"/balance/update",{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({id:u.id,currency:"ton",amount:win?bet:-bet})})
      .then(_=>fetch(`${apiUrl}/balance/${u.id}`)).then(r=>r.json()).then(d=>{
        document.querySelectorAll(".balance span")[0].textContent=d.ton.toFixed(2);
        document.querySelectorAll(".balance span")[1].textContent=d.usdt.toFixed(2);
      });
    }

    let bet=100,minBet=10,maxBet=1000;
    function updateBetUI(){document.querySelectorAll('#betValue').forEach(s=>s.innerText=bet)}
    function changeBet(delta){bet=Math.min(Math.max(bet+delta,minBet),maxBet);updateBetUI()}
    function setBet(type){bet=type==='min'?minBet:type==='max'?maxBet:bet;updateBetUI()}

    let playerChoice='';
    function setCoinChoice(c){playerChoice=c;
      document.getElementById('btn-heads').classList.toggle('active',c==='heads');
      document.getElementById('btn-tails').classList.toggle('active',c==='tails');}

    function playCoin(){
      if(bet<minBet)return alert('–ú–∏–Ω '+minBet);
      if(!playerChoice)return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ—Ä–æ–Ω—É');
      const result=Math.random()<0.5?'heads':'tails';
      const img=document.getElementById('coinImageMain');
      img.classList.remove('flip');void img.offsetWidth;img.classList.add('flip');
      setTimeout(()=>{
        img.src='assets/coin-'+result+'.png';
        const w=result===playerChoice;
        document.getElementById('coinResult').innerText=
          `–í—ã–ø–∞–ª–æ: ${result==='heads'?'–û–†–Å–õ':'–†–ï–®–ö–ê'}\n${w?'–ü–æ–±–µ–¥–∞!':'–ü—Ä–æ–∏–≥—Ä—ã—à'}`;
        recordGame('coin',bet,result,w);
      },600);
    }

    function selectBox(choice){
      if(bet<minBet)return alert('–ú–∏–Ω '+minBet);
      const prize=Math.floor(Math.random()*3);
      const w=choice===prize;
      document.getElementById('boxResult').innerText=
        w?'–ü—Ä–∏–∑ –Ω–∞–π–¥–µ–Ω! –ü–æ–±–µ–¥–∞!':'–ü—É—Å—Ç–æ. –ü—Ä–æ–∏–≥—Ä—ã—à.';
      recordGame('boxes',bet,w?'win':'lose',w);
    }

    function rollDice(){
      if(bet<minBet)return alert('–ú–∏–Ω '+minBet);
      const d1=Math.floor(Math.random()*6)+1, d2=Math.floor(Math.random()*6)+1;
      const total=d1+d2, w=total>=8;
      document.getElementById('dice1').src=`assets/dice${d1}.png`;
      document.getElementById('dice2').src=`assets/dice${d2}.png`;
      document.getElementById('diceResult').innerText=
        `–°—É–º–º–∞: ${total}\n${w?'–ü–æ–±–µ–¥–∞!':'–ü—Ä–æ–∏–≥—Ä—ã—à'}`;
      recordGame('dice',bet,`${d1}+${d2}`,w);
    }
  </script>
</body>
</html>
